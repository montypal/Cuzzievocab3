/* ===========================
   GAME STATE
   =========================== */
let xp = 0;
let streak = 0;
let questionNumber = 1;
let currentQuestion = null;
let questionLocked = false;

let goForGold = false;
let goldCooldown = 0;

// Track used words so they NEVER repeat
let usedWords = [];

const BASE_XP = 100;
const GOLD_MULTIPLIER = 2;

/* ===========================
   DOM ELEMENTS
   =========================== */
const xpDisplay = document.getElementById("xpDisplay");
const streakDisplay = document.getElementById("streakDisplay");
const questionCounter = document.getElementById("questionCounter");
const modeBadge = document.getElementById("modeBadge");
const questionArea = document.getElementById("questionArea");
const answerArea = document.getElementById("answerArea");
const feedbackArea = document.getElementById("feedbackArea");
const submitButton = document.getElementById("submitButton");
const nextButton = document.getElementById("nextButton");
const goldToggleButton = document.getElementById("goldToggleButton");

/* ===========================
   UTILITIES
   =========================== */
function shuffle(arr) {
  return arr.sort(() => Math.random() - 0.5);
}

function normalize(t) {
  return t.trim().toLowerCase();
}

function updateStats() {
  xpDisplay.textContent = xp;
  streakDisplay.textContent = streak;
  questionCounter.textContent = questionNumber;
}

/* ===========================
   GOLD MODE + COOLDOWN
   =========================== */
function updateGoldUI() {
  if (goldCooldown > 0) {
    goldToggleButton.classList.add("off");
    goldToggleButton.textContent = `Cooldown: ${goldCooldown}`;
    modeBadge.textContent = "Gold: COOLDOWN";
    modeBadge.classList.add("gold-off");
    return;
  }

  if (goForGold) {
    goldToggleButton.classList.remove("off");
    goldToggleButton.textContent = "Gold: ON";
    modeBadge.textContent = "Gold: ON";
    modeBadge.classList.remove("gold-off");
  } else {
    goldToggleButton.classList.add("off");
    goldToggleButton.textContent = "Go for the Gold";
    modeBadge.textContent = "Gold: OFF";
    modeBadge.classList.add("gold-off");
  }
}

goldToggleButton.addEventListener("click", () => {
  if (questionLocked) return;
  if (goldCooldown > 0) return;
  goForGold = !goForGold;
  updateGoldUI();
});

/* ===========================
   GET RANDOM WORD (NO REPEATS)
   =========================== */
function getRandomWord() {
  const available = VOCAB.filter(v => !usedWords.includes(v.word));
  if (available.length === 0) {
    alert("You completed ALL vocab words! No repeats ever.");
    return null;
  }
  const chosen = available[Math.floor(Math.random() * available.length)];
  usedWords.push(chosen.word);
  return chosen;
}

/* ===========================
   QUESTION GENERATION
   =========================== */
function generateQuestion() {
  questionLocked = false;
  submitButton.disabled = false;
  nextButton.disabled = true;
  feedbackArea.innerHTML = "";

  const qType = shuffle(["definitionWord", "fillBlank", "nuance", "termToDefinition"])[0];
  const item = getRandomWord();
  if (!item) return;

  currentQuestion = { type: qType, item, selected: null };

  if (qType === "definitionWord") renderDefinitionQuestion(item);
  if (qType === "fillBlank") renderFillBlank(item);
  if (qType === "nuance") renderNuance(item);
  if (qType === "termToDefinition") renderTermToDefinition(item);

  updateGoldUI();
}

/* ===========================
   QUESTION TYPES
   =========================== */
function renderDefinitionQuestion(item) {
  const wrong = shuffle(
    VOCAB.filter(v => v.word !== item.word && !usedWords.includes(v.word))
  ).slice(0, 3);

  const options = shuffle([item.word, ...wrong.map(w => w.word)]);

  questionArea.innerHTML = `
    <div class="question-main">Which word matches this definition?</div>
    <div>${item.definition}</div>
  `;

  answerArea.innerHTML = `
    <div class="options-grid">
      ${options
        .map(
          (o, i) => `
            <button class="option-btn" data-opt="${o}">
              ${String.fromCharCode(65 + i)}. ${o}
            </button>
          `
        )
        .join("")}
    </div>
  `;

  answerArea.querySelectorAll(".option-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      if (questionLocked) return;
      answerArea.querySelectorAll(".option-btn").forEach(b => b.classList.remove("selected"));
      btn.classList.add("selected");
      currentQuestion.selected = btn.dataset.opt;
    });
  });
}

function renderFillBlank(item) {
  const masked = item.word.replace(/[A-Za-z]/g, "*");

  questionArea.innerHTML = `
    <div class="question-main">Fill in the missing word</div>
    <div class="fill-blank">
      <strong>Definition:</strong> ${item.definition}<br><br>
      Example: ${item.example.replace(
        new RegExp(item.word, "i"),
        `<span class="blank">${masked}</span>`
      )}
    </div>
  `;

  answerArea.innerHTML = `
    <div class="input-row">
      <input id="fillInput" type="text" placeholder="Type the wordâ€¦" />
    </div>
  `;
}

function renderNuance(item) {
  const wrong = shuffle(
    VOCAB.filter(v => v.word !== item.word && !usedWords.includes(v.word))
  ).slice(0, 3);

  const options = shuffle([item.word, ...wrong.map(w => w.word)]);

  questionArea.innerHTML = `
    <div class="question-main">Which word fits this description?</div>
    <div>${item.nuance}</div>
  `;

  answerArea.innerHTML = `
    <div class="options-grid">
      ${options
        .map(
          (o, i) => `
            <button class="option-btn" data-opt="${o}">
              ${String.fromCharCode(65 + i)}. ${o}
            </button>
          `
        )
        .join("")}
    </div>
  `;

  answerArea.querySelectorAll(".option-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      if (questionLocked) return;
      answerArea.querySelectorAll(".option-btn").forEach(b => b.classList.remove("selected"));
      btn.classList.add("selected");
      currentQuestion.selected = btn.dataset.opt;
    });
  });
}

function renderTermToDefinition(item) {
  const wrong = shuffle(
    VOCAB.filter(v => v.word !== item.word && !usedWords.includes(v.word))
  ).slice(0, 3);

  const options = shuffle([item.definition, ...wrong.map(w => w.definition)]);

  questionArea.innerHTML = `
    <div class="question-main">
      What is the definition of <span class="word-highlight">${item.word}</span>?
    </div>
  `;

  answerArea.innerHTML = `
    <div class="options-grid">
      ${options
        .map(
          (o, i) => `
            <button class="option-btn" data-opt="${o}">
              ${String.fromCharCode(65 + i)}. ${o}
            </button>
          `
        )
        .join("")}
    </div>
  `;

  answerArea.querySelectorAll(".option-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      if (questionLocked) return;
      answerArea.querySelectorAll(".option-btn").forEach(b => b.classList.remove("selected"));
      btn.classList.add("selected");
      currentQuestion.selected = btn.dataset.opt;
    });
  });
}

/* ===========================
   CHECK ANSWER
   =========================== */
function checkAnswer() {
  if (questionLocked) return;

  const item = currentQuestion.item;
  let userAnswer = null;
  let correct = false;

  if (currentQuestion.type === "fillBlank") {
    const input = document.getElementById("fillInput");
    if (!input || !input.value.trim()) return;
    userAnswer = normalize(input.value);
    correct = userAnswer === normalize(item.word);

  } else if (currentQuestion.type === "termToDefinition") {
    userAnswer = currentQuestion.selected;
    correct = normalize(userAnswer) === normalize(item.definition);

  } else {
    userAnswer = currentQuestion.selected;
    correct = normalize(userAnswer) === normalize(item.word);
  }

  questionLocked = true;
  submitButton.disabled = true;
  nextButton.disabled = false;

  let xpChange = 0;

  if (correct) {
    xpChange = goForGold ? BASE_XP * GOLD_MULTIPLIER : BASE_XP;
    xp += xpChange;
    streak++;

    feedbackArea.innerHTML = `
      <div class="feedback correct">
        <strong>Correct!</strong><br>
        Word: <span class="word-highlight">${item.word}</span><br>
        Definition: ${item.definition}<br>
        Example: "${item.example}"<br>
        +${xpChange} XP
      </div>
    `;
  } else {
    xpChange = goForGold ? -BASE_XP * GOLD_MULTIPLIER : 0;
    xp = Math.max(0, xp + xpChange);
    streak = 0;

    feedbackArea.innerHTML = `
      <div class="feedback incorrect">
        <strong>Incorrect.</strong><br>
        Correct word: <span class="word-highlight">${item.word}</span><br>
        Definition: ${item.definition}<br>
        Example: "${item.example}"<br>
        ${xpChange < 0 ? `${xpChange} XP (Gold penalty)` : ""}
      </div>
    `;
  }

  if (goForGold) {
    goForGold = false;
    goldCooldown = 3;
  }

  updateGoldUI();
  updateStats();
}

/* ===========================
   BUTTONS
   =========================== */
submitButton.addEventListener("click", checkAnswer);

nextButton.addEventListener("click", () => {
  if (!questionLocked) return;

  questionNumber++;
  if (goldCooldown > 0) goldCooldown--;
  updateGoldUI();
  updateStats();
  generateQuestion();
});

/* ===========================
   START GAME
   =========================== */
updateStats();
generateQuestion();


